<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Precision Crop Management</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
<div class="container">
    <h2>ðŸŒ± Precision Crop Management System</h2>

    <!-- ERROR MESSAGE -->
    {% if error %}
        <div class="card" style="color:red;">{{ error }}</div>
    {% endif %}

    <!-- FORM -->
    <form action="/predict" method="post">

        <input type="number" name="area" placeholder="Farm Area (hectares)" step="any" required>

        <input type="number" name="N" placeholder="Nitrogen (N)" step="any" required>
        <input type="number" name="P" placeholder="Phosphorus (P)" step="any" required>
        <input type="number" name="K" placeholder="Potassium (K)" step="any" required>

        <input type="number" name="ph" placeholder="Soil pH" step="any" required>
        <input type="number" name="rainfall" placeholder="Rainfall (mm)" step="any" required>

        <button type="submit">Predict</button>
    </form>

    <!-- RESULTS -->
    {% if crop %}
        <div class="card">ðŸŒ¾ <b>Crop:</b> {{ crop }}</div>
        <div class="card">ðŸŒ¿ <b>Fertilizer:</b> {{ fertilizer }} ({{ fert_amount }} kg)</div>
        <div class="card">ðŸ’§ <b>Irrigation:</b> {{ irrigation }}</div>
        <div class="card">ðŸ“Š <b>Expected Yield:</b> {{ yield_estimate }} tons</div>
        <div class="card">ðŸŒ¦ <b>Weather:</b> {{ temperature }}Â°C | {{ humidity }}%</div>

        <!-- NPK CHART -->
        <canvas id="npkChart"></canvas>

        <!-- MAP -->
        <div id="map" style="height:300px; margin-top:20px;"></div>

        <!-- SAFE DATA TRANSFER -->
        <script id="chart-data"
            data-npk='{{ [N, P, K] | tojson }}'
            data-lat='{{ lat }}'
            data-lon='{{ lon }}'>
        </script>

        <script>
            const el = document.getElementById("chart-data");

            const npk = JSON.parse(el.dataset.npk);
            const lat = parseFloat(el.dataset.lat);
            const lon = parseFloat(el.dataset.lon);

            // NPK BAR CHART
            new Chart(document.getElementById("npkChart"), {
                type: "bar",
                data: {
                    labels: ["Nitrogen", "Phosphorus", "Potassium"],
                    datasets: [{
                        label: "Soil Nutrient Levels",
                        data: npk,
                        backgroundColor: ["#66bb6a", "#ffa726", "#42a5f5"]
                    }]
                }
            });

            // MAP
            const map = L.map("map").setView([lat, lon], 10);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
            L.marker([lat, lon]).addTo(map);
        </script>
    {% endif %}
</div>
</body>
</html>
